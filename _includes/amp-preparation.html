<!-- AMP (Accelerated Mobile Pages) Preparation -->

<!-- AMP HTML Link Discovery -->
{% if page.amp_url %}
<link rel="amphtml" href="{{ site.url }}{{ page.amp_url }}">
{% endif %}

<!-- AMP Story Discovery -->
{% if page.amp_story %}
<link rel="amphtml" href="{{ site.url }}/amp/stories/{{ page.slug }}.html">
{% endif %}

<!-- Structured Data for AMP -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "@id": "{{ site.url }}{{ page.url }}#amp-ready",
  "isPartOf": {
    "@type": "WebSite",
    "name": "{{ site.title }}",
    "url": "{{ site.url }}"
  },
  "potentialAction": {
    "@type": "ViewAction",
    "target": [
      {
        "@type": "EntryPoint",
        "urlTemplate": "{{ site.url }}{{ page.url }}",
        "actionPlatform": [
          "http://schema.org/DesktopWebPlatform",
          "http://schema.org/MobileWebPlatform"
        ]
      }
      {% if page.amp_url %}
      ,{
        "@type": "EntryPoint",
        "urlTemplate": "{{ site.url }}{{ page.amp_url }}",
        "actionPlatform": [
          "http://schema.org/MobileWebPlatform"
        ],
        "description": "AMP 版本"
      }
      {% endif %}
    ]
  }
}
</script>

<!-- Preload AMP Runtime (for future use) -->
{% if page.has_amp %}
<link rel="preload" as="script" href="https://cdn.ampproject.org/v0.js">
<link rel="preload" as="script" href="https://cdn.ampproject.org/v0/amp-carousel-0.1.js">
<link rel="preload" as="script" href="https://cdn.ampproject.org/v0/amp-sidebar-0.1.js">
<link rel="preload" as="script" href="https://cdn.ampproject.org/v0/amp-accordion-0.1.js">
{% endif %}

<!-- AMP Boilerplate CSS (inline for future AMP pages) -->
<style amp-boilerplate>
  body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}
</style>
<noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>

<!-- AMP Components Preconnect -->
<link rel="preconnect" href="https://cdn.ampproject.org">
<link rel="dns-prefetch" href="https://cdn.ampproject.org">

<!-- AMP-compatible Metadata -->
<meta name="amp-google-client-id-api" content="googleanalytics">
<meta name="amp-consent-blocking" content="amp-ad,amp-analytics,amp-social-share">

<!-- Prepare Images for AMP -->
<script>
  // Prepare image data for AMP conversion
  document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('img');
    const ampImageData = [];
    
    images.forEach((img, index) => {
      if (img.src && !img.src.startsWith('data:')) {
        ampImageData.push({
          src: img.src,
          alt: img.alt || '',
          width: img.naturalWidth || img.width || 800,
          height: img.naturalHeight || img.height || 600,
          layout: img.classList.contains('responsive') ? 'responsive' : 'intrinsic'
        });
      }
    });
    
    // Store for potential AMP conversion
    window.ampImageData = ampImageData;
  });
</script>

<!-- AMP Story Metadata -->
{% if page.collection == "rooms" %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "AmpStory",
  "@id": "{{ site.url }}/amp/stories/{{ page.slug }}",
  "publisher": {
    "@type": "Organization",
    "name": "{{ site.title }}",
    "logo": {
      "@type": "ImageObject",
      "url": "{{ site.url }}{{ site.logo }}",
      "width": 512,
      "height": 512
    }
  },
  "headline": "{{ page.title }} - 互動式導覽",
  "datePublished": "{{ page.date | date_to_xmlschema }}",
  "dateModified": "{{ page.modified_date | default: page.date | date_to_xmlschema }}",
  "description": "透過 AMP Story 體驗 {{ page.title }}",
  "image": [
    "{{ site.url }}/{{ page.main_image }}"
  ]
}
</script>
{% endif %}

<!-- PWA + AMP Integration -->
<meta name="amp-manifest" content="/amp-manifest.json">

<!-- Prepare Content for AMP -->
<script>
  // Flag AMP-incompatible elements
  (function() {
    'use strict';
    
    // Elements that need conversion for AMP
    const incompatibleSelectors = [
      'script:not([type="application/ld+json"])',
      'style:not([amp-boilerplate]):not([amp-custom])',
      'iframe:not([src*="youtube.com"]):not([src*="vimeo.com"])',
      'form:not([action*="formspree.io"])',
      'input[type="range"]',
      'video:not([poster])',
      'audio:not([preload])'
    ];
    
    const ampIncompatible = [];
    
    incompatibleSelectors.forEach(selector => {
      const elements = document.querySelectorAll(selector);
      if (elements.length > 0) {
        ampIncompatible.push({
          selector: selector,
          count: elements.length,
          elements: Array.from(elements).map(el => ({
            tag: el.tagName,
            id: el.id,
            class: el.className
          }))
        });
      }
    });
    
    // Store for AMP conversion reference
    window.ampCompatibilityReport = {
      incompatible: ampIncompatible,
      timestamp: new Date().toISOString(),
      pageUrl: window.location.href
    };
    
    console.log('AMP Compatibility Report:', window.ampCompatibilityReport);
  })();
</script>

<!-- AMP Real URL -->
<link rel="canonical" href="{{ page.url | prepend: site.url }}">

<!-- Prepare Carousel for AMP -->
{% if page.images %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ImageGallery",
  "@id": "{{ site.url }}{{ page.url }}#amp-carousel",
  "name": "{{ page.title }} 圖片集",
  "associatedMedia": [
    {% for image in page.images %}
    {
      "@type": "ImageObject",
      "contentUrl": "{{ site.url }}/{{ image }}",
      "thumbnail": "{{ site.url }}/{{ image | replace: '.jpg', '-thumb.jpg' }}",
      "name": "{{ page.title }} - 圖片 {{ forloop.index }}"
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
}
</script>
{% endif %}