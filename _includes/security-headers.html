<!-- Advanced Security Headers and Meta Tags -->

<!-- Security Headers via Meta Tags -->
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
<meta http-equiv="Permissions-Policy" content="accelerometer=(), camera=(), geolocation=*, gyroscope=(), magnetometer=(), microphone=(), payment=*, usb=()">

<!-- Content Security Policy -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self' https:;
  script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.google-analytics.com https://www.googletagmanager.com https://ajax.googleapis.com https://cdnjs.cloudflare.com https://maxcdn.bootstrapcdn.com;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://maxcdn.bootstrapcdn.com https://cdnjs.cloudflare.com;
  img-src 'self' data: https: blob:;
  font-src 'self' data: https://fonts.gstatic.com https://maxcdn.bootstrapcdn.com https://cdnjs.cloudflare.com;
  connect-src 'self' https://www.google-analytics.com https://formspree.io https://api.line.me;
  media-src 'self' https:;
  object-src 'none';
  frame-src 'self' https://www.youtube.com https://www.facebook.com https://player.vimeo.com;
  frame-ancestors 'self';
  base-uri 'self';
  form-action 'self' https://formspree.io;
  manifest-src 'self';
  worker-src 'self';
  upgrade-insecure-requests;
">

<!-- Additional Security Measures -->
<meta name="format-detection" content="telephone=no">
<meta http-equiv="x-dns-prefetch-control" content="on">

<!-- HSTS Preload (requires server configuration) -->
<meta name="strict-transport-security" content="max-age=31536000; includeSubDomains; preload">

<!-- Subresource Integrity for External Resources -->
<script>
  // Add SRI to external resources dynamically
  document.addEventListener('DOMContentLoaded', function() {
    // Bootstrap CSS SRI
    const bootstrapCSS = document.querySelector('link[href*="bootstrap"]');
    if (bootstrapCSS && !bootstrapCSS.integrity) {
      bootstrapCSS.integrity = 'sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO';
      bootstrapCSS.crossOrigin = 'anonymous';
    }
    
    // jQuery SRI
    const jquery = document.querySelector('script[src*="jquery"]');
    if (jquery && !jquery.integrity) {
      jquery.integrity = 'sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT';
      jquery.crossOrigin = 'anonymous';
    }
  });
</script>

<!-- Security.txt Reference -->
<link rel="security.txt" href="/security.txt">
<link rel="author" href="/humans.txt">

<!-- Certificate Transparency -->
<meta name="expect-ct" content="max-age=86400, enforce">

<!-- Feature Policy / Permissions Policy -->
<meta http-equiv="Feature-Policy" content="
  camera 'none';
  microphone 'none';
  payment 'self';
  usb 'none';
  geolocation 'self';
  picture-in-picture 'self';
  accelerometer 'none';
  ambient-light-sensor 'none';
  autoplay 'self';
  battery 'none';
  display-capture 'none';
  document-domain 'none';
  encrypted-media 'self';
  fullscreen 'self';
  gyroscope 'none';
  magnetometer 'none';
  midi 'none';
  sync-xhr 'none';
  vr 'none';
  wake-lock 'none';
  xr-spatial-tracking 'none';
">

<!-- CORS Headers -->
<meta http-equiv="Access-Control-Allow-Origin" content="{{ site.url }}">
<meta http-equiv="Access-Control-Allow-Methods" content="GET, HEAD">
<meta http-equiv="Access-Control-Allow-Headers" content="Content-Type">

<!-- Anti-Clickjacking -->
<style id="antiClickjack">
  body {
    display: none !important;
  }
</style>
<script>
  if (self === top) {
    var antiClickjack = document.getElementById("antiClickjack");
    antiClickjack.parentNode.removeChild(antiClickjack);
  } else {
    top.location = self.location;
  }
</script>

<!-- GDPR and Privacy Compliance -->
<meta name="privacy-policy" content="{{ site.url }}/privacy">
<meta name="terms-of-service" content="{{ site.url }}/terms">

<!-- Security Event Logging -->
<script>
  // Log security events
  (function() {
    'use strict';
    
    // Detect and log potential XSS attempts
    const originalWrite = document.write;
    document.write = function() {
      console.warn('document.write() called - potential XSS vector');
      // Optionally send to analytics
      if (typeof gtag !== 'undefined') {
        gtag('event', 'security_warning', {
          'event_category': 'Security',
          'event_label': 'document.write attempted'
        });
      }
      return originalWrite.apply(document, arguments);
    };
    
    // Monitor for suspicious activity
    let clickCount = 0;
    const clickThreshold = 50;
    const timeWindow = 5000; // 5 seconds
    
    document.addEventListener('click', function() {
      clickCount++;
      setTimeout(() => clickCount--, timeWindow);
      
      if (clickCount > clickThreshold) {
        console.warn('Potential click flooding detected');
        // Implement rate limiting
        document.body.style.pointerEvents = 'none';
        setTimeout(() => {
          document.body.style.pointerEvents = 'auto';
          clickCount = 0;
        }, 3000);
      }
    });
    
    // Detect console opening (basic protection)
    let devtools = {open: false, orientation: null};
    const threshold = 160;
    setInterval(function() {
      if (window.outerHeight - window.innerHeight > threshold || 
          window.outerWidth - window.innerWidth > threshold) {
        if (!devtools.open) {
          devtools.open = true;
          console.log('DevTools detected');
        }
      } else {
        devtools.open = false;
      }
    }, 500);
  })();
</script>

<!-- Structured Data for Security Contact -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ContactPoint",
  "@id": "{{ site.url }}/#security-contact",
  "contactType": "security",
  "email": "security@{{ site.url | replace: 'https://', '' | replace: 'http://', '' }}",
  "url": "{{ site.url }}/security",
  "availableLanguage": ["zh-TW", "en"]
}
</script>