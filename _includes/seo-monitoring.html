<!-- SEO Monitoring and Analytics -->

<script>
  // SEO Performance Monitoring
  (function() {
    'use strict';
    
    // SEO Data Collection
    window.seoData = {
      pageTitle: document.title,
      metaDescription: document.querySelector('meta[name="description"]')?.content,
      canonicalUrl: document.querySelector('link[rel="canonical"]')?.href,
      pageUrl: window.location.href,
      loadTime: 0,
      structuredDataCount: 0,
      imagesWithAlt: 0,
      totalImages: 0,
      internalLinks: 0,
      externalLinks: 0,
      headings: {
        h1: 0,
        h2: 0,
        h3: 0,
        h4: 0,
        h5: 0,
        h6: 0
      }
    };
    
    // Page Load Performance
    window.addEventListener('load', function() {
      if (window.performance) {
        const perfData = window.performance.timing;
        window.seoData.loadTime = perfData.loadEventEnd - perfData.navigationStart;
        
        // Log performance metrics
        console.log('Page Load Time:', window.seoData.loadTime + 'ms');
        
        // Send to analytics if available
        if (typeof gtag !== 'undefined') {
          gtag('event', 'timing_complete', {
            'name': 'load',
            'value': window.seoData.loadTime,
            'event_category': 'SEO Performance'
          });
        }
      }
    });
    
    // Analyze SEO Elements
    function analyzeSEO() {
      // Count structured data scripts
      window.seoData.structuredDataCount = document.querySelectorAll('script[type="application/ld+json"]').length;
      
      // Analyze images
      const images = document.querySelectorAll('img');
      window.seoData.totalImages = images.length;
      images.forEach(img => {
        if (img.alt && img.alt.trim() !== '') {
          window.seoData.imagesWithAlt++;
        }
      });
      
      // Analyze links
      const links = document.querySelectorAll('a[href]');
      links.forEach(link => {
        const href = link.getAttribute('href');
        if (href.startsWith('http') && !href.includes(window.location.hostname)) {
          window.seoData.externalLinks++;
        } else if (href.startsWith('/') || href.startsWith('#') || href.includes(window.location.hostname)) {
          window.seoData.internalLinks++;
        }
      });
      
      // Count headings
      for (let i = 1; i <= 6; i++) {
        window.seoData.headings['h' + i] = document.querySelectorAll('h' + i).length;
      }
      
      // Log SEO analysis
      console.log('SEO Analysis:', window.seoData);
    }
    
    // Run analysis when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', analyzeSEO);
    } else {
      analyzeSEO();
    }
    
    // Monitor Core Web Vitals
    function monitorCoreWebVitals() {
      // Cumulative Layout Shift (CLS)
      let clsValue = 0;
      let clsEntries = [];
      
      const clsObserver = new PerformanceObserver((entryList) => {
        for (const entry of entryList.getEntries()) {
          if (!entry.hadRecentInput) {
            clsValue += entry.value;
            clsEntries.push({
              value: entry.value,
              time: entry.startTime
            });
          }
        }
      });
      
      clsObserver.observe({ type: 'layout-shift', buffered: true });
      
      // Largest Contentful Paint (LCP)
      const lcpObserver = new PerformanceObserver((entryList) => {
        const entries = entryList.getEntries();
        const lastEntry = entries[entries.length - 1];
        
        console.log('LCP:', lastEntry.renderTime || lastEntry.loadTime, 'ms');
        
        // Track in analytics
        if (typeof gtag !== 'undefined') {
          gtag('event', 'web_vitals', {
            'event_category': 'Web Vitals',
            'event_label': 'LCP',
            'value': Math.round(lastEntry.renderTime || lastEntry.loadTime)
          });
        }
      });
      
      lcpObserver.observe({ type: 'largest-contentful-paint', buffered: true });
      
      // First Input Delay (FID)
      const fidObserver = new PerformanceObserver((entryList) => {
        const firstInput = entryList.getEntries()[0];
        const fid = firstInput.processingStart - firstInput.startTime;
        
        console.log('FID:', fid, 'ms');
        
        // Track in analytics
        if (typeof gtag !== 'undefined') {
          gtag('event', 'web_vitals', {
            'event_category': 'Web Vitals',
            'event_label': 'FID',
            'value': Math.round(fid)
          });
        }
      });
      
      fidObserver.observe({ type: 'first-input', buffered: true });
      
      // Report CLS when page is about to unload
      window.addEventListener('beforeunload', () => {
        console.log('CLS:', clsValue);
        
        // Track in analytics
        if (typeof gtag !== 'undefined') {
          gtag('event', 'web_vitals', {
            'event_category': 'Web Vitals',
            'event_label': 'CLS',
            'value': Math.round(clsValue * 1000) // Convert to milliseconds for consistency
          });
        }
      });
    }
    
    // Initialize Core Web Vitals monitoring
    if ('PerformanceObserver' in window) {
      monitorCoreWebVitals();
    }
    
    // Track scroll depth for engagement
    let maxScrollDepth = 0;
    let scrollTimer = null;
    
    function trackScrollDepth() {
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const scrollPercentage = Math.round((scrollTop + windowHeight) / documentHeight * 100);
      
      if (scrollPercentage > maxScrollDepth) {
        maxScrollDepth = scrollPercentage;
      }
      
      // Clear existing timer
      clearTimeout(scrollTimer);
      
      // Set new timer to track after scrolling stops
      scrollTimer = setTimeout(() => {
        if (typeof gtag !== 'undefined' && maxScrollDepth > 0) {
          gtag('event', 'scroll_depth', {
            'event_category': 'Engagement',
            'event_label': maxScrollDepth + '%',
            'value': maxScrollDepth
          });
        }
      }, 1000);
    }
    
    window.addEventListener('scroll', trackScrollDepth, { passive: true });
    
    // Track time on page
    const startTime = Date.now();
    
    window.addEventListener('beforeunload', () => {
      const timeOnPage = Math.round((Date.now() - startTime) / 1000); // in seconds
      
      if (typeof gtag !== 'undefined' && timeOnPage > 0) {
        gtag('event', 'time_on_page', {
          'event_category': 'Engagement',
          'value': timeOnPage
        });
      }
    });
    
    // Monitor 404 errors
    if (document.title.includes('404') || document.body.textContent.includes('找不到頁面')) {
      console.error('404 Error:', window.location.href);
      
      if (typeof gtag !== 'undefined') {
        gtag('event', '404_error', {
          'event_category': 'SEO Errors',
          'event_label': window.location.href,
          'referrer': document.referrer
        });
      }
    }
    
    // Structured Data Validation Helper
    function validateStructuredData() {
      const scripts = document.querySelectorAll('script[type="application/ld+json"]');
      const errors = [];
      
      scripts.forEach((script, index) => {
        try {
          const data = JSON.parse(script.textContent);
          
          // Basic validation
          if (!data['@context']) {
            errors.push(`Script ${index + 1}: Missing @context`);
          }
          if (!data['@type']) {
            errors.push(`Script ${index + 1}: Missing @type`);
          }
          
          // Type-specific validation
          if (data['@type'] === 'Organization' || data['@type'] === 'LodgingBusiness') {
            if (!data.name) errors.push(`Script ${index + 1}: Missing name for ${data['@type']}`);
            if (!data.url) errors.push(`Script ${index + 1}: Missing url for ${data['@type']}`);
          }
          
          if (data['@type'] === 'Product') {
            if (!data.name) errors.push(`Script ${index + 1}: Missing name for Product`);
            if (!data.offers) errors.push(`Script ${index + 1}: Missing offers for Product`);
          }
          
        } catch (e) {
          errors.push(`Script ${index + 1}: Invalid JSON - ${e.message}`);
        }
      });
      
      if (errors.length > 0) {
        console.warn('Structured Data Validation Errors:', errors);
      } else {
        console.log('Structured Data Validation: All scripts valid');
      }
      
      return errors;
    }
    
    // Run structured data validation
    validateStructuredData();
    
    // Expose SEO utilities for debugging
    window.seoUtils = {
      getData: () => window.seoData,
      validateStructuredData: validateStructuredData,
      checkImages: () => {
        const images = document.querySelectorAll('img');
        const issues = [];
        
        images.forEach((img, index) => {
          if (!img.alt || img.alt.trim() === '') {
            issues.push(`Image ${index + 1}: Missing alt text - ${img.src}`);
          }
          if (!img.loading) {
            issues.push(`Image ${index + 1}: Missing loading attribute - ${img.src}`);
          }
        });
        
        return issues;
      },
      checkHeadings: () => {
        const h1Count = document.querySelectorAll('h1').length;
        const issues = [];
        
        if (h1Count === 0) {
          issues.push('No H1 tag found on page');
        } else if (h1Count > 1) {
          issues.push(`Multiple H1 tags found (${h1Count})`);
        }
        
        return issues;
      },
      generateReport: () => {
        const report = {
          seoData: window.seoData,
          structuredDataErrors: validateStructuredData(),
          imageIssues: window.seoUtils.checkImages(),
          headingIssues: window.seoUtils.checkHeadings()
        };
        
        console.log('SEO Report:', report);
        return report;
      }
    };
    
  })();
</script>

<!-- Schema.org Validator Link (Development Only) -->
{% if jekyll.environment != "production" %}
<script>
  console.log('Schema.org Validator: https://validator.schema.org/#url=' + encodeURIComponent(window.location.href));
</script>
{% endif %}